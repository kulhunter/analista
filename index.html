<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solucionador.cl - Dashboard Inteligente</title>
    
    <!-- Stack Tecnológico -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #334155; }
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .prose-analysis p { margin-bottom: 1em; line-height: 1.6; font-size: 1rem; color: #475569; }
        .prose-analysis strong { color: #0f172a; font-weight: 700; }
        .prose-analysis li { margin-bottom: 0.5em; }
        .prose-analysis ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        
        /* Efecto de pensamiento de IA */
        .thinking-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- RECHARTS SAFE IMPORT ---
        const Recharts = window.Recharts || {};
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
            ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell, AreaChart, Area 
        } = Recharts;

        const COLORS = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2', '#db2777'];

        // --- ICONOS (COMPONENTES INDIVIDUALES) ---
        const BrainIcon = ({className}) => (
            <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
        );
        const UploadIcon = ({className}) => (
            <svg className={className || "w-12 h-12 text-blue-500"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );
        const RefreshIcon = ({className}) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );
        const SparklesIcon = ({className}) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
        );
        const LockIcon = ({className}) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
        );
        const TrashIcon = ({className}) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const ExternalLinkIcon = ({className}) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
        );

        // --- CEREBRO LOCAL (PRE-PROCESAMIENTO) ---
        const processDataLocally = (data) => {
            const headers = Object.keys(data[0]);
            const columns = {};

            headers.forEach(h => {
                let numCount = 0;
                let dateCount = 0;
                let sum = 0;
                let distinct = new Set();
                
                data.forEach(row => {
                    const val = row[h];
                    if (typeof val === 'number') { numCount++; sum += val; }
                    else if (val instanceof Date) dateCount++;
                    else if (typeof val === 'string') {
                        const clean = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',','.'));
                        if (!isNaN(clean) && val.match(/\d/)) { 
                            numCount++; sum += clean; 
                        } else {
                            distinct.add(val);
                        }
                    }
                });

                let type = 'string';
                if (numCount > data.length * 0.7) type = 'number';
                else if (dateCount > data.length * 0.7) type = 'date';

                columns[h] = { type, sum, distinct: distinct.size };
            });

            return { headers, columns, rowCount: data.length, sample: data.slice(0, 5) };
        };

        // --- CONEXIÓN DEEPSEEK ---
        const askDeepSeek = async (apiKey, fileSummary) => {
            const prompt = `
                Actúa como un Analista de Datos Senior experto en Visualización para Solucionador.cl.
                Tengo un dataset con la siguiente estructura (Metadata):
                ${JSON.stringify(fileSummary)}

                Tu tarea es:
                1. Deducir de qué trata el archivo (Ventas, Marketing, Inventario, RRHH, etc).
                2. Escribir un resumen ejecutivo (HTML <p>, <strong>) explicando los hallazgos potenciales.
                3. Identificar 3 KPIs numéricos clave para mostrar en tarjetas (título, y qué columna usar para calcularlo).
                4. Diseñar 2 gráficos relevantes:
                   - Gráfico 1: Debe ser de Barras o Torta. Define qué columna es la categoría (X) y cuál es el valor (Y).
                   - Gráfico 2: Si hay fechas, haz un gráfico de Línea (Tendencia). Si no, haz otro de Barras.

                Responde ESTRICTAMENTE en formato JSON válido con esta estructura:
                {
                    "title": "Título del Dashboard",
                    "summary": "Texto HTML del análisis...",
                    "kpis": [
                        { "label": "Título KPI", "column": "NombreColumnaExacto", "operation": "sum" | "count" | "avg" }
                    ],
                    "charts": [
                        { "id": "chart1", "type": "bar"|"line"|"pie", "title": "Título Gráfico", "x_column": "ColumnaX", "y_column": "ColumnaY" },
                        { "id": "chart2", "type": "bar"|"line"|"pie", "title": "Título Gráfico", "x_column": "ColumnaX", "y_column": "ColumnaY" }
                    ]
                }
                No incluyas markdown, solo el JSON raw.
            `;

            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.2
                })
            });

            if (!response.ok) {
                if (response.status === 401) throw new Error("API Key inválida");
                throw new Error("Error conectando con DeepSeek");
            }

            const json = await response.json();
            let cleanContent = json.choices[0].message.content;
            cleanContent = cleanContent.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(cleanContent);
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [apiKey, setApiKey] = useState(localStorage.getItem('ds_key') || '');
            const [view, setView] = useState(apiKey ? 'UPLOAD' : 'LOGIN');
            const [status, setStatus] = useState('IDLE');
            const [rawData, setRawData] = useState([]);
            const [dashboardConfig, setDashboardConfig] = useState(null);
            const [processedCharts, setProcessedCharts] = useState([]);
            const [processedKPIs, setProcessedKPIs] = useState([]);
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);

            const handleLogin = (key) => {
                if(!key.startsWith('sk-')) { alert("La llave debe empezar con sk-"); return; }
                localStorage.setItem('ds_key', key);
                setApiKey(key);
                setView('UPLOAD');
            };

            const handleLogout = () => {
                localStorage.removeItem('ds_key');
                setApiKey('');
                setRawData([]);
                setDashboardConfig(null);
                setView('LOGIN');
            };

            const processFile = async (file) => {
                setStatus('READING');
                try {
                    const buffer = await file.arrayBuffer();
                    const wb = XLSX.read(buffer);
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rawJson = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    let headerIndex = 0, maxCols = 0;
                    rawJson.slice(0, 15).forEach((row, idx) => {
                        const cols = row.filter(c => typeof c === 'string' && c.length > 1).length;
                        if(cols > maxCols) { maxCols = cols; headerIndex = idx; }
                    });

                    const range = XLSX.utils.decode_range(ws['!ref']);
                    range.s.r = headerIndex;
                    const data = XLSX.utils.sheet_to_json(ws, { range: range, defval: null });
                    setRawData(data);

                    const summary = processDataLocally(data);
                    
                    setStatus('THINKING');
                    const aiConfig = await askDeepSeek(apiKey, summary);
                    setDashboardConfig(aiConfig);

                    const calcKPIs = aiConfig.kpis.map(kpi => {
                        let val = 0;
                        if (kpi.operation === 'count') {
                            val = data.length;
                        } else {
                            val = data.reduce((acc, row) => {
                                const v = row[kpi.column];
                                const num = typeof v === 'number' ? v : parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0;
                                return acc + num;
                            }, 0);
                            if (kpi.operation === 'avg') val = val / data.length;
                        }
                        return { ...kpi, value: val };
                    });
                    setProcessedKPIs(calcKPIs);

                    const calcCharts = aiConfig.charts.map(chart => {
                        const map = {};
                        data.forEach(row => {
                            let xVal = row[chart.x_column];
                            if (chart.type === 'line' && (String(xVal).includes('/') || String(xVal).includes('-'))) {
                                const d = new Date(xVal);
                                if (!isNaN(d)) xVal = d.toISOString().split('T')[0];
                            }
                            const key = String(xVal || 'Otros');
                            
                            let yVal = 0;
                            if (chart.y_column) {
                                const rawY = row[chart.y_column];
                                yVal = typeof rawY === 'number' ? rawY : parseFloat(String(rawY).replace(/[^\d.-]/g, '')) || 0;
                            } else {
                                yVal = 1;
                            }

                            map[key] = (map[key] || 0) + yVal;
                        });

                        let chartData = Object.entries(map).map(([name, value]) => ({ name, value }));
                        if (chart.type === 'line') {
                            chartData.sort((a,b) => new Date(a.name) - new Date(b.name));
                        } else {
                            chartData.sort((a,b) => b.value - a.value).slice(0, 10);
                        }
                        return { ...chart, data: chartData };
                    });
                    setProcessedCharts(calcCharts);

                    setStatus('DONE');

                } catch (e) {
                    console.error(e);
                    if (e.message.includes("API Key")) {
                        alert("Tu API Key de DeepSeek no es válida o se quedó sin saldo.");
                        handleLogout();
                    } else {
                        alert("Error procesando: " + e.message);
                        setStatus('IDLE');
                    }
                }
            };

            // --- VISTAS ---

            if (view === 'LOGIN') return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-slate-900">
                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_50%,rgba(59,130,246,0.1),transparent_50%)]"></div>

                    <div className="glass-card p-8 rounded-2xl max-w-md w-full relative z-10 shadow-2xl animate-fade-in text-center">
                        <div className="flex justify-center mb-6">
                            <div className="p-3 bg-blue-600 rounded-xl shadow-lg">
                                <BrainIcon className="w-10 h-10 text-white" />
                            </div>
                        </div>
                        
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Solucionador.cl AI</h2>
                        <p className="text-slate-500 text-sm mb-8">
                            Para iniciar el análisis inteligente, conecta tu API Key de DeepSeek.
                        </p>

                        <div className="text-left space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-blue-500 uppercase mb-1">DeepSeek API Key</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <LockIcon className="w-4 h-4" />
                                    </div>
                                    <input 
                                        type="password" 
                                        placeholder="sk-..." 
                                        className="w-full pl-10 pr-4 py-3 rounded-xl text-sm border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        onKeyDown={(e) => e.key === 'Enter' && handleLogin(e.target.value)}
                                    />
                                </div>
                            </div>

                            <button 
                                onClick={() => handleLogin(document.querySelector('input[type="password"]').value)}
                                className="w-full py-3 rounded-xl text-white font-bold bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all"
                            >
                                Conectar y Continuar
                            </button>

                            <div className="pt-4 border-t border-slate-100 flex justify-between items-center text-xs">
                                <span className="text-slate-500">¿No tienes una llave?</span>
                                <a 
                                    href="https://platform.deepseek.com/api_keys" 
                                    target="_blank" 
                                    className="text-blue-500 hover:text-blue-600 flex items-center gap-1 font-medium transition-colors"
                                >
                                    Obtener API Key <ExternalLinkIcon className="w-3 h-3" />
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'UPLOAD') return (
                <div className="min-h-screen bg-slate-900 text-white flex flex-col">
                    <header className="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="p-1.5 bg-blue-600 rounded-lg">
                                <BrainIcon className="w-5 h-5 text-white" />
                            </div>
                            <span className="font-medium text-slate-300">Solucionador.cl / Analyst</span>
                        </div>
                        <button onClick={handleLogout} className="text-xs text-slate-500 hover:text-red-400 transition-colors flex items-center gap-2">
                            <LockIcon className="w-3 h-3" /> Desconectar API
                        </button>
                    </header>

                    <div className="flex-1 flex flex-col items-center justify-center p-4">
                        {status === 'IDLE' && (
                            <div className="p-12 rounded-3xl text-center max-w-2xl w-full border-dashed border-2 border-slate-700 bg-slate-800/50 hover:border-blue-500/50 transition-all group">
                                <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-xl shadow-black/20">
                                    <span className="text-blue-500"><UploadIcon className="w-10 h-10" /></span>
                                </div>
                                <h2 className="text-3xl font-bold mb-4 text-white">Sube tu Archivo</h2>
                                <p className="text-slate-400 mb-8 max-w-md mx-auto">
                                    Excel (.xlsx) o CSV. DeepSeek analizará la estructura, identificará el contexto y generará el reporte automáticamente.
                                </p>
                                <label className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold cursor-pointer inline-flex items-center gap-3 shadow-lg shadow-blue-500/20 transition-all">
                                    Seleccionar Archivo
                                    <input type="file" className="hidden" accept=".csv,.xlsx,.xls" onChange={(e) => e.target.files[0] && processFile(e.target.files[0])} />
                                </label>
                            </div>
                        )}

                        {status === 'READING' && (
                            <div className="text-center">
                                <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                                <h3 className="text-xl font-bold animate-pulse">Leyendo datos...</h3>
                            </div>
                        )}

                        {status === 'THINKING' && (
                            <div className="text-center">
                                <div className="relative w-24 h-24 mx-auto mb-6 pulse-glow rounded-full flex items-center justify-center bg-blue-500/10">
                                    <div className="text-blue-400"><BrainIcon className="w-12 h-12" /></div>
                                </div>
                                <h3 className="text-xl font-bold text-blue-400">DeepSeek está pensando...</h3>
                                <p className="text-slate-500 mt-2">Analizando patrones y redactando reporte</p>
                            </div>
                        )}

                        {status === 'DONE' && (
                            <div className="w-full max-w-6xl animate-fade-in pb-20">
                                <div className="p-8 rounded-2xl mb-8 relative overflow-hidden bg-slate-800 border border-slate-700">
                                    <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-blue-500 to-purple-500"></div>
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="p-2 bg-blue-500/20 text-blue-400 rounded-lg"><BrainIcon className="w-6 h-6" /></div>
                                        <h2 className="text-2xl font-bold text-white">{dashboardConfig.title}</h2>
                                    </div>
                                    <div className="prose-ai text-slate-300" dangerouslySetInnerHTML={{__html: dashboardConfig.summary}}></div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    {processedKPIs.map((kpi, idx) => (
                                        <div key={idx} className="p-6 rounded-2xl border-t-4 border-t-blue-500/50 bg-slate-800 border border-slate-700">
                                            <p className="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">{kpi.label}</p>
                                            <p className="text-3xl font-bold text-white">
                                                {kpi.value.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </p>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    {processedCharts.map((chart, idx) => (
                                        <div key={idx} className={`p-6 rounded-2xl bg-slate-800 border border-slate-700 ${chart.type === 'line' ? 'lg:col-span-2' : ''}`}>
                                            <div className="flex items-center justify-between mb-6">
                                                <h3 className="font-bold text-lg text-white">{chart.title}</h3>
                                                <span className="text-xs bg-slate-900 px-2 py-1 rounded text-slate-400 border border-slate-600 uppercase">{chart.type}</span>
                                            </div>
                                            <div className="h-72 w-full">
                                                <ResponsiveContainer>
                                                    {chart.type === 'bar' ? (
                                                        <BarChart data={chart.data} layout="vertical" margin={{left: 0}}>
                                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#334155" />
                                                            <XAxis type="number" hide />
                                                            <YAxis dataKey="name" type="category" width={100} fontSize={11} stroke="#94a3b8" />
                                                            <Tooltip contentStyle={{backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc'}} />
                                                            <Bar dataKey="value" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20} />
                                                        </BarChart>
                                                    ) : chart.type === 'line' ? (
                                                        <AreaChart data={chart.data}>
                                                            <defs>
                                                                <linearGradient id={`grad${idx}`} x1="0" y1="0" x2="0" y2="1">
                                                                    <stop offset="5%" stopColor={COLORS[idx]} stopOpacity={0.5}/>
                                                                    <stop offset="95%" stopColor={COLORS[idx]} stopOpacity={0}/>
                                                                </linearGradient>
                                                            </defs>
                                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" />
                                                            <XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickMargin={10} minTickGap={30} />
                                                            <YAxis stroke="#94a3b8" fontSize={12} />
                                                            <Tooltip contentStyle={{backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc'}} />
                                                            <Area type="monotone" dataKey="value" stroke={COLORS[idx]} fill={`url(#grad${idx})`} strokeWidth={3} />
                                                        </AreaChart>
                                                    ) : (
                                                        <PieChart>
                                                            <Pie data={chart.data} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5}>
                                                                {chart.data.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                                            </Pie>
                                                            <Tooltip contentStyle={{backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc'}} />
                                                            <Legend />
                                                        </PieChart>
                                                    )}
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="text-center mt-12">
                                    <button onClick={() => { setStatus('IDLE'); setRawData([]); }} className="text-slate-400 hover:text-white flex items-center gap-2 mx-auto transition-colors">
                                        <RefreshIcon className="w-4 h-4" /> Analizar otro archivo
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
